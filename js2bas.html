<html>
<head>
<script>
	function onInpChange() {
		const lines = document.getElementById('inp').value.split('\n');
		let ret = '';
		const funcs = {};
		const consts = {};
		const outLines = lines.map((l, i) => {
			const ix = i*10+10;
			l = l.trim().toUpperCase();
			if(l.substr(0,1)==='~') {
				let p = l.substr(1).split(/\s+/);
				const params = p.splice(1).map(t => t.trim());
				funcs[p[0]] = {addr: ix, params};
				return [ix, `REM ${p[0]}(${params.join(',')})`];
			} else if(l.substr(0,1)==='@') {
				let p = l.substr(1).split(/\s+/);
				const params = p.splice(1);
				return [ix, {func:p[0], params}];
			} else if(l.substr(0,1)==='#') { // const
				let p = l.split(/\s+/);
				consts[p[0]] = p[1];
				return [ix, `REM ${p[0].substr(1)} = ${p[1]}`];
			} else if (l==='') {
				return [ix, 'REM'];
			}
			return [ix, l];
		});
		
		const constKeys = Object.keys(consts);
		
		outLines.forEach((l) => {
			if(l[1].func) {
				const {addr, params} = funcs[l[1].func];
				let s = '';
				params.forEach((p,j) => {
				    if(l[1].params[j]!=='_'){
						s += `${p} = ${l[1].params[j]}:`
					}
				});
				s += `GOSUB ${addr}: REM ${l[1].func}`;
				l[1] = s;				
			}
			constKeys.forEach((k) => {
				 const r = new RegExp(k,'g');
				 l[1] = l[1].replace(r, consts[k]);
			});
		});
		let outText = outLines.map(l=>l.join(' ')).join('\n');
		document.getElementById('out').innerHTML = outText;
	}
	
	function selectText(node) {
		node = document.getElementById(node);

		if (document.body.createTextRange) {
			const range = document.body.createTextRange();
			range.moveToElementText(node);
			range.select();
		} else if (window.getSelection) {
			const selection = window.getSelection();
			const range = document.createRange();
			range.selectNodeContents(node);
			selection.removeAllRanges();
			selection.addRange(range);
		} else {
			console.warn("Could not select text in node: Unsupported browser.");
		}
	}
</script>
</head>
<table width='900' border='1'>
<tr>
<td><textarea style='width:400px;height:400px' id='inp'>#blue 5
#red 3
print "hello"
print "world";#BLUE
  @posCursor   _   _

  ~posCursor   x   y
     return</textarea></td>
<td><pre id='out' onclick="selectText('out')"></pre></td>
</tr>
</table>
<button onclick='onInpChange()'>Submit</button>
<br/><br/>
<h3>Help</h3>
<div id='help'>
<table>
<tr><td>#&lt;CONST NAME&gt; &lt;CONST VALUE&gt;</td><td>constant definition. Will be replaced globbaly</td></tr>
<tr><td>~&lt;FUNCTION NAME&gt; [PARAM_NAME] [PARAM_NAME] ...</td><td>function definition with list of used params</td></tr>
<tr><td>@&lt;FUNCTION NAME&gt; [VAL|_] [VAL|_] ...</td><td>function call with list of used values or '_' - to skipp assigment</td></tr>
</table>

</div>
	
</html>
